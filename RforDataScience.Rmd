---
title: "RforDataScience"
author: "Jatinder Singh Malhi"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(nycflights13)
```

```{r}
ggplot(data = mpg)+geom_point(mapping = aes(x = displ, y = hwy))+ facet_wrap(~ class, nrow = 2)
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  facet_grid(drv ~ .)
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  facet_grid(. ~ cyl)
```

## Geom Smooth Function
```{r}
ggplot(data = mpg)+geom_point(mapping = aes(x= displ,y = hwy))
ggplot(data = mpg)+ geom_smooth(mapping = aes(x= displ,y = hwy, linetype =drv))
ggplot(data = mpg) +
geom_smooth(
mapping = aes(x = displ, y = hwy, color = drv),
show.legend = FALSE
)
ggplot(data = mpg, mapping = aes(x= displ,y = hwy))+geom_point(mapping = aes(color = class))+geom_smooth()
ggplot(data = mpg, mapping = aes(x= displ,y = hwy))+geom_point(mapping = aes(color = class))+geom_smooth(data = filter(mpg, class == "subcompact"),se = FALSE)
```

## EXERCISE
```{r}
ggplot(data = mpg, mapping = aes(x =displ,y = hwy, color= drv))+geom_point()+geom_smooth(se = FALSE)
ggplot(data = mpg, mapping = aes(x =displ,y = hwy))+geom_point(mapping = aes(color = drv))+geom_smooth()
ggplot(data = mpg, mapping = aes(x= displ,y =hwy))+geom_point()+geom_smooth()
```

## Statistical Transformation

```{r}
ggplot(data = diamonds)+geom_bar(mapping = aes(x= cut))
ggplot(data = diamonds)+geom_bar(mapping = aes(x= cut, y = ..prop.., group =  1))
ggplot(data = diamonds) +geom_bar(mapping = aes(x = cut, fill = cut))
ggplot(data = diamonds) +geom_bar(mapping = aes(x = cut, fill = clarity))
ggplot(data = diamonds) +geom_bar(mapping = aes(x = cut, fill = clarity),position = "fill")
ggplot(data = diamonds) +geom_bar(mapping = aes(x = cut, fill = clarity),position = "dodge")
ggplot(data = diamonds)+geom_bar(mapping = aes(x= cut, fill = cut),show.legend = FALSE,width = 1)+theme(aspect.ratio = 1)+labs(x = NULL, y = NULL)+coord_flip()
ggplot(data = diamonds)+geom_bar(mapping = aes(x= cut, fill = cut),show.legend = FALSE,width = 1)+theme(aspect.ratio = 1)+labs(x = NULL, y = NULL)+coord_polar()
```

## Exercise
```{r}
ggplot(data = mpg, mapping = aes(x = cty, y = hwy,color = drv)) +geom_point() +
  geom_smooth()
ggplot(data = mpg, mapping = aes(x = cty, y = hwy, color = class)) +
  geom_count(position = "jitter")
ggplot(data = mpg, aes(x = drv, y = hwy, colour = class)) +
  geom_boxplot()
ggplot(data = diamonds)+geom_bar(mapping = aes(x= cut, fill= clarity),position = "fill") + coord_polar(theta = "y")
ggplot(data = mpg, mapping = aes(x = cty, y = hwy)) +geom_point() +geom_abline() +coord_fixed()
```
The function coord_fixed() ensures that the line produced by geom_abline() is at a 45-degree angle. A 45-degree line makes it easy to compare the highway and city mileage to the case in which city and highway MPG were equal.
ggplot(data = <DATA>) + <GEOM_FUNCTION>(mapping = aes(<MAPPINGS>),
stat = <STAT>,position = <POSITION>) +<COORDINATE_FUNCTION> +<FACET_FUNCTION>
Our new template takes 7 parameters

##  DPLYR
Filter function
```{r}
head(flights)
nrow(flights)
filter(flights,carrier %in% c("UA", "AA", "DL"))
filter(flights,arr_delay >= 2 )
filter(flights, month %in% c(07,08,09))
filter(flights, hour >= 00:00:00 & hour <= 06:00:00 )
```

Arrange function 
```{r}
arrange(flights,(dep_delay))
head(arrange(flights,air_time))
```

Select function
```{r}
# select(flights, c(dep_time,dep_delay,arr_time,arr_delay))
# select(flights, starts_with("dep_"), starts_with("arr_"))
# select(flights, contains("TIME"))
# select(flights, contains("TIME", ignore.case = FALSE))
# 
# new_variable <- flights %>% group_by(dest) %>% summarize(count = n(), 
#         dist = mean(distance, na.rm = TRUE),delay = mean(arr_delay, na.rm = TRUE)) %>% filter(count > 20 , dest != "HNL")
# ggplot(data = new_variable, mapping = aes(x = dist, y = delay))+geom_point(mapping = aes(size = count), alpha = 1/3)
not_cancelled <- flights %>% filter(!is.na(dep_delay), !is.na(arr_delay))
delays <- not_cancelled %>% group_by(tailnum) %>% summarize(delay = mean(arr_delay), n = n()) %>% filter(n >25)
ggplot(delays, mapping = aes(x = n, y = delay))+ geom_point(alpha = 1/10)
not_cancelled %>% group_by(year, month, day) %>% summarize(avg_delay1 = mean(arr_delay), avg_delay2 = mean(arr_delay[arr_delay > 0]))
not_cancelled %>% group_by(year, month, day) %>% summarize( first_dep = first(dep_time), last_dept = last(dep_time))
```

##  Exercises Page 72
```{r}
(head(flights))
not_cancelled %>% count(dest) 
not_cancelled %>% count(tailnum, wt = distance)
not_cancelled %>% group_by(dest) %>% summarize(n= n()) 
not_cancelled %>% group_by(tailnum) %>% summarize(n= n())
#group_by and summarize together can achieve count function

filter(flights, !is.na(dep_delay), is.na(arr_delay)) %>% select(dep_time, arr_time, sched_arr_time, dep_delay, arr_delay)
#Important column is arr_delay
flight_cancellation <- flights %>% mutate(cancelled = (is.na(arr_delay) | is.na(dep_delay))) %>% group_by(year, month, day) %>% summarize(cancelled_num = sum(cancelled), flights_num = n())
ggplot(data = flight_cancellation, mapping = aes(flights_num, cancelled_num)) + geom_point()

average_delay <- flights %>% mutate(cancelled = (is.na(arr_delay) | is.na(dep_delay))) %>% 
  group_by(year, month, day) %>% summarize(cancelled_prop = mean(cancelled), mean_depdelay = mean(dep_delay, na.rm = TRUE), mean_arrdelay = mean(arr_delay, na.rm = TRUE)) %>% ungroup
ggplot(average_delay, mapping = aes(mean_depdelay, cancelled_prop, color = mean_depdelay)) + geom_point() + stat_smooth(method = "lm", color = "green") + labs(x = "Average Delay", y = "Cancelled Proportion", title = "Cancelled Proportion vs Average Delay")
# Graph shows there is strong linear relationship

worst_carrier <- flights %>% group_by(carrier) %>% summarize(arrival_delay = mean(arr_delay, na.rm = TRUE), n = n()) %>% arrange(desc(arrival_delay))
filter(airlines, carrier == "F9")
```

























Grouped Mutates(and Filters)
##  Exercises Page 75
```{r}
flights <- flights
worst_plane <- flights %>% group_by(tailnum) %>% filter(arr_delay > 0) %>% arrange(desc(arr_delay)) %>% select(tailnum, arr_delay)
fly_time <- flights %>% group_by(hour) %>% summarize(arrival_delay = mean(arr_delay, na.rm = TRUE)) %>% arrange(arrival_delay)
destination_delays <- flights %>% group_by(dest) %>% filter(arr_delay > 0) %>% mutate(total_arrival_delay = sum(arr_delay), arrival_delay_proportion = arr_delay/total_arrival_delay) %>% select(dest, month, day, dep_time, carrier, flight, arr_delay, arrival_delay_proportion) %>% arrange(dest, desc(arrival_delay_proportion))
lagged_delays <- flights %>%   arrange(origin, month, day, dep_time) %>%  group_by(origin) %>%
  mutate(dep_delay_lag = lag(dep_delay)) %>%  filter(!is.na(dep_delay), !is.na(dep_delay_lag))
flight_standardization <- flights %>% group_by(dest, origin) %>% filter(!is.na(air_time)) %>% mutate(n = n(), mean_airtime = mean(air_time), sd_airtime = sd(air_time)) %>% mutate(standardized_airtime = (air_time -mean_airtime)/(sd_airtime+1))
ggplot(flight_standardization, aes(x = standardized_airtime)) +
  geom_density()
#> Warning: Removed 4 rows containing non-finite values (stat_density).
```












